<?xml version="1.0" encoding="UTF-8"?>
<svg width="1500" height="1200" xmlns="http://www.w3.org/2000/svg">
  <!-- 定义样式 -->
  <defs>
    <!-- 箭头标记 -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2c3e50"/>
    </marker>
    <marker id="arrowhead-data" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3498db"/>
    </marker>
    <marker id="arrowhead-control" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c"/>
    </marker>
    <marker id="arrowhead-jump" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f39c12"/>
    </marker>
    <marker id="arrowhead-csr" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9b59b6"/>
    </marker>
    <marker id="arrowhead-alu" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60"/>
    </marker>
    <marker id="arrowhead-mem" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8b4513"/>
    </marker>
  </defs>

  <!-- CPU标题 -->
  <text x="750" y="80" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#34495e">
    ysyx_24090003_cpu (RISC-V 单周期处理器核心)
  </text>

  <!-- 背景 -->
  <rect width="1520" height="1100" fill="#f8f9fa" stroke="none"/>
  
  <!-- 标题 -->
  <text x="700" y="30" font-family="Arial, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    RISC-V CPU 架构图 - 详细信号流和指令处理
  </text>
  <text x="700" y="50" font-family="Arial, sans-serif" font-size="12" text-anchor="middle" fill="#7f8c8d">
    ysyx_24090003 单周期CPU设计 (算术/跳转/异常指令详细实现)
  </text>
  
  <!-- ========== 五大模块 ========== -->
  
  <!-- IFU模块 -->
  <rect x="60" y="100" width="180" height="140" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="8"/>
  
  <!-- IFU内部DPI-C标记 -->
  <rect x="70" y="110" width="50" height="16" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="95" y="120" font-family="Arial, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="white">DPI-C PC跟踪</text>
  
  <!-- IFU内部PC+4加法器标记 -->
  <rect x="130" y="110" width="45" height="16" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="152" y="120" font-family="Arial, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="white">32位加法器</text>
  
  <text x="150" y="140" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    IFU
  </text>
  <text x="150" y="155" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    指令获取单元
  </text>
  <text x="150" y="175" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • PC寄存器管理
  </text>
  <text x="150" y="190" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 指令内存读取
  </text>
  <text x="150" y="205" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • PC+4顺序计算
  </text>
  <text x="150" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 跳转PC更新控制
  </text>

  <!-- IDU模块 -->
  <rect x="290" y="100" width="180" height="140" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="8"/>
  
  <!-- IDU内部指令类型识别标记 -->
  <rect x="300" y="110" width="35" height="12" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="317" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">R型</text>
  
  <rect x="340" y="110" width="35" height="12" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="357" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">I型</text>
  
  <rect x="380" y="110" width="35" height="12" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="397" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">S/B/U/J型</text>
  
  <rect x="420" y="110" width="35" height="12" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="437" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">CSR型</text>
  
  <text x="380" y="140" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    IDU
  </text>
  <text x="380" y="155" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    指令解码单元
  </text>
  <text x="380" y="175" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 指令字段提取
  </text>
  <text x="380" y="190" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 立即数格式化
  </text>
  <text x="380" y="205" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • ALU/内存控制生成
  </text>
  <text x="380" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 跳转/异常识别
  </text>

  <!-- EXU模块 -->
  <rect x="520" y="100" width="180" height="140" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="8"/>
  
  <!-- EXU内部DPI-C标记 -->
  <rect x="530" y="110" width="60" height="16" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="560" y="120" font-family="Arial, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="white">DPI-C 执行跟踪</text>
  
  <!-- EXU内部双ALU标记 -->
  <rect x="600" y="110" width="40" height="12" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="620" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">主ALU</text>
  
  <rect x="650" y="110" width="40" height="12" fill="#27ae60" stroke="#229954" stroke-width="1" rx="2"/>
  <text x="670" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">PC_ALU</text>
  
  <text x="610" y="140" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    EXU
  </text>
  <text x="610" y="155" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    执行单元
  </text>
  <text x="610" y="175" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 双ALU运算架构
  </text>
  <text x="610" y="190" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 独立分支判断逻辑
  </text>
  <text x="610" y="205" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 跳转地址计算
  </text>
  <text x="610" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 异常处理控制
  </text>

  <!-- LSU模块 -->
  <rect x="750" y="100" width="180" height="140" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="8"/>
  
  <!-- LSU内部访存类型标记 -->
  <rect x="760" y="110" width="35" height="12" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="777" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">LB/LH/LW</text>
  
  <rect x="800" y="110" width="35" height="12" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="817" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">SB/SH/SW</text>
  
  <rect x="840" y="110" width="35" height="12" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="857" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">符号扩展</text>
  
  <rect x="880" y="110" width="35" height="12" fill="#34495e" stroke="#2c3e50" stroke-width="1" rx="2"/>
  <text x="897" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">写掩码</text>
  
  <text x="840" y="140" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    LSU
  </text>
  <text x="840" y="155" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    访存单元
  </text>
  <text x="840" y="175" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 内存地址计算
  </text>
  <text x="840" y="190" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 字节/半字/字访问
  </text>
  <text x="840" y="205" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 数据符号扩展
  </text>
  <text x="840" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#ecf0f1">
    • 写掩码生成
  </text>

  <!-- WBU+RegFile模块 -->
  <rect x="980" y="100" width="180" height="140" fill="#1abc9c" stroke="#16a085" stroke-width="2" rx="8"/>
  
  <!-- WBU内部DPI-C标记 -->
  <rect x="990" y="110" width="65" height="16" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="1022" y="120" font-family="Arial, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="white">DPI-C 寄存器跟踪</text>
  
  <!-- WBU内部CSR寄存器标记 -->
  <rect x="1060" y="110" width="20" height="12" fill="#9b59b6" stroke="#8e44ad" stroke-width="1" rx="2"/>
  <text x="1070" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">mtvec</text>
  
  <rect x="1085" y="110" width="20" height="12" fill="#9b59b6" stroke="#8e44ad" stroke-width="1" rx="2"/>
  <text x="1095" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">mepc</text>
  
  <rect x="1110" y="110" width="20" height="12" fill="#9b59b6" stroke="#8e44ad" stroke-width="1" rx="2"/>
  <text x="1120" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">mcause</text>
  
  <rect x="1135" y="110" width="20" height="12" fill="#9b59b6" stroke="#8e44ad" stroke-width="1" rx="2"/>
  <text x="1145" y="119" font-family="Arial, sans-serif" font-size="7" font-weight="bold" text-anchor="middle" fill="white">mstatus</text>
  
  <text x="1070" y="140" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    WBU+RegFile
  </text>
  <text x="1070" y="155" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="white">
    写回&amp;寄存器
  </text>
  <text x="1070" y="175" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 写回数据选择
  </text>
  <text x="1070" y="190" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 32个通用寄存器
  </text>
  <text x="1070" y="205" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • CSR寄存器管理
  </text>
  <text x="1070" y="220" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#2c3e50">
    • 异常状态保存
  </text>

  <!-- ========== 主要数据流 ========== -->
  
  <!-- 1. 指令流: IFU -> IDU -->
  <path d="M 240 170 L 290 170" stroke="#3498db" stroke-width="3" fill="none" marker-end="url(#arrowhead-data)"/>
  <text x="265" y="160" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#3498db">inst[31:0]</text>

  <!-- 2. 控制流: IDU -> EXU -->
  <path d="M 470 170 L 520 170" stroke="#e74c3c" stroke-width="3" fill="none" marker-end="url(#arrowhead-control)"/>
  <text x="495" y="160" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#e74c3c">控制信号</text>

  <!-- 3. 执行流: EXU -> LSU -->
  <path d="M 700 170 L 750 170" stroke="#f39c12" stroke-width="3" fill="none" marker-end="url(#arrowhead-jump)"/>
  <text x="725" y="160" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#f39c12">alu_result</text>

  <!-- 4. 访存流: LSU -> WBU -->
  <path d="M 930 170 L 980 170" stroke="#9b59b6" stroke-width="3" fill="none" marker-end="url(#arrowhead-csr)"/>
  <text x="955" y="160" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#9b59b6">mem_data</text>

  <!-- 5. 寄存器读取: WBU -> EXU (直角路径) -->
  <path d="M 1070 240 L 1070 290 L 610 290 L 610 240" stroke="#1abc9c" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="840" y="285" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#1abc9c">rs1_data/rs2_data</text>

  <!-- ========== 跳转控制回路 ========== -->
  
  <!-- PC控制回路: EXU -> IFU (直角路径) -->
  <path d="M 610 100 L 610 60 L 150 60 L 150 100" stroke="#f39c12" stroke-width="4" fill="none" marker-end="url(#arrowhead-jump)" stroke-dasharray="8,4"/>
  <text x="380" y="74" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#f39c12">next_pc / pc_update_en (跳转控制)</text>

  <!-- ========== CSR异常处理回路 ========== -->
  
  <!-- 1. IDU -> WBU: CSR控制信号 (直角路径) -->
  <path d="M 380 240 L 380 300 L 1070 300 L 1070 240" stroke="#9b59b6" stroke-width="3" fill="none" marker-end="url(#arrowhead-csr)" stroke-dasharray="6,3"/>
  <text x="520" y="315" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#9b59b6">CSR控制 (csr_we/addr/op/ecall/mret)</text>
  
  <!-- 2. WBU -> EXU: CSR读取数据 (直角路径，上方) -->
  <path d="M 980 100 L 980 70 L 610 70 L 610 100" stroke="#8e44ad" stroke-width="3" fill="none" marker-end="url(#arrowhead-csr)"/>
  <text x="790" y="80" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#8e44ad">CSR读取 (csr_rdata/mtvec/mepc)</text>
  
  <!-- 3. EXU -> WBU: CSR写入数据 (直角路径，下方) -->
  <path d="M 700 240 L 700 310 L 980 310 L 980 240" stroke="#7d3c98" stroke-width="2" fill="none" marker-end="url(#arrowhead-csr)" stroke-dasharray="4,2"/>
  <text x="840" y="320" font-family="Arial, sans-serif" font-size="9" font-weight="bold" text-anchor="middle" fill="#7d3c98">CSR写入 (csr_wdata)</text>

  <!-- ========== ALU详细展开图 ========== -->
  
  <!-- ALU模块详细展开 -->
  <rect x="50" y="350" width="650" height="200" fill="#ecf0f1" stroke="#95a5a6" stroke-width="2" rx="8"/>
  <text x="375" y="375" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    ALU运算单元详细架构 (基于门电路实现)
  </text>

  <!-- 主ALU模块 -->
  <rect x="70" y="390" width="140" height="130" fill="#27ae60" stroke="#229954" stroke-width="2" rx="8"/>
  <text x="140" y="415" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="white">主ALU</text>
  <text x="140" y="430" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="white">算术逻辑运算</text>
  
  <!-- ALU操作列表 -->
  <text x="80" y="445" font-family="Arial, sans-serif" font-size="8" fill="white">• ADD/SUB (加法器)</text>
  <text x="80" y="455" font-family="Arial, sans-serif" font-size="8" fill="white">• AND/OR/XOR (逻辑)</text>
  <text x="80" y="465" font-family="Arial, sans-serif" font-size="8" fill="white">• SLL (桶形左移)</text>
  <text x="80" y="475" font-family="Arial, sans-serif" font-size="8" fill="white">• SRL/SRA (桶形右移)</text>
  <text x="80" y="485" font-family="Arial, sans-serif" font-size="8" fill="white">• SLT/SLTU (比较器)</text>
  <text x="80" y="495" font-family="Arial, sans-serif" font-size="8" fill="white">• LUI (立即数传递)</text>
  
  <!-- 32位加法器模块 -->
  <rect x="230" y="390" width="120" height="80" fill="#3498db" stroke="#2980b9" stroke-width="2" rx="6"/>
  <text x="290" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">32位加法器</text>
  <text x="290" y="425" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">串联32个全加器</text>
  <text x="240" y="440" font-family="Arial, sans-serif" font-size="8" fill="white">• 全加器→半加器</text>
  <text x="240" y="450" font-family="Arial, sans-serif" font-size="8" fill="white">• 基于NAND门实现</text>
  <text x="240" y="460" font-family="Arial, sans-serif" font-size="8" fill="white">• 进位传播链</text>

  <!-- PC_ALU模块 -->
  <rect x="370" y="390" width="120" height="80" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="6"/>
  <text x="430" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">PC_ALU</text>
  <text x="430" y="425" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">专用地址计算</text>
  <text x="380" y="440" font-family="Arial, sans-serif" font-size="8" fill="white">• PC+imm (跳转)</text>
  <text x="380" y="450" font-family="Arial, sans-serif" font-size="8" fill="white">• rs1+imm (JALR)</text>
  <text x="380" y="460" font-family="Arial, sans-serif" font-size="8" fill="white">• 异常向量地址</text>

  <!-- 桶形移位器模块 -->
  <rect x="510" y="390" width="120" height="80" fill="#9b59b6" stroke="#8e44ad" stroke-width="2" rx="6"/>
  <text x="570" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">桶形移位器</text>
  <text x="570" y="425" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">5级移位电路</text>
  <text x="520" y="440" font-family="Arial, sans-serif" font-size="8" fill="white">• 1/2/4/8/16位移位</text>
  <text x="520" y="450" font-family="Arial, sans-serif" font-size="8" fill="white">• 逻辑/算术右移</text>
  <text x="520" y="460" font-family="Arial, sans-serif" font-size="8" fill="white">• 符号扩展控制</text>

  <!-- 比较器模块 -->
  <rect x="230" y="480" width="120" height="60" fill="#e74c3c" stroke="#c0392b" stroke-width="2" rx="6"/>
  <text x="290" y="500" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">比较器</text>
  <text x="290" y="515" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">有符号/无符号</text>
  <text x="240" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">• SLT: 符号位判断</text>

  <!-- 逻辑运算模块 -->
  <rect x="370" y="480" width="120" height="60" fill="#e67e22" stroke="#d35400" stroke-width="2" rx="6"/>
  <text x="430" y="500" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">逻辑运算</text>
  <text x="430" y="515" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">位运算操作</text>
  <text x="380" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">• AND/OR/XOR操作</text>

  <!-- ALU输入选择器 -->
  <rect x="510" y="480" width="120" height="60" fill="#1abc9c" stroke="#16a085" stroke-width="2" rx="6"/>
  <text x="570" y="500" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">输入选择器</text>
  <text x="570" y="515" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="white">2:1多路选择</text>
  <text x="520" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">• REG/IMM/PC/ZERO</text>

  <!-- ========== EXU独立模块 ========== -->
  
  <!-- EXU分支判断模块（独立于ALU） -->
  <rect x="50" y="560" width="650" height="60" fill="#f39c12" stroke="#e67e22" stroke-width="2" rx="8"/>
  <text x="375" y="580" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="white">
    EXU独立分支判断逻辑
  </text>
  
  <text x="50" y="600" font-family="Arial, sans-serif" font-size="10" fill="white">
    • BEQ/BNE: 使用ALU减法结果的零标志位判断 • BLT/BGE/BLTU/BGEU: 使用ALU比较结果的最低位判断 • 分支条件与ALU运算结果组合生成
  </text>
  <text x="56" y="610" font-family="Arial, sans-serif" font-size="10" fill="white">
    branch_taken信号
  </text>
  <!-- ========== 详细指令分类表 ========== -->
  
  <rect x="720" y="350" width="720" height="270" fill="#34495e" stroke="#2c3e50" stroke-width="2" rx="8"/>
  <text x="1080" y="375" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
    RISC-V指令详细分类 (已实现指令集)
  </text>

  <!-- R型指令 -->
  <rect x="740" y="390" width="160" height="75" fill="#e74c3c" stroke="#c0392b" stroke-width="1" rx="4"/>
  <text x="820" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">R型算术指令</text>
  <text x="750" y="425" font-family="Arial, sans-serif" font-size="8" fill="white">ADD/SUB rs1±rs2→rd</text>
  <text x="750" y="435" font-family="Arial, sans-serif" font-size="8" fill="white">AND/OR/XOR rs1⊕rs2→rd</text>
  <text x="750" y="445" font-family="Arial, sans-serif" font-size="8" fill="white">SLL/SRL/SRA 移位操作</text>
  <text x="750" y="455" font-family="Arial, sans-serif" font-size="8" fill="white">SLT/SLTU 比较运算</text>

  <!-- I型指令 -->
  <rect x="920" y="390" width="160" height="75" fill="#3498db" stroke="#2980b9" stroke-width="1" rx="4"/>
  <text x="1000" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">I型立即数指令</text>
  <text x="930" y="425" font-family="Arial, sans-serif" font-size="8" fill="white">ADDI rs1+imm→rd</text>
  <text x="930" y="435" font-family="Arial, sans-serif" font-size="8" fill="white">ANDI/ORI/XORI 逻辑立即数</text>
  <text x="930" y="445" font-family="Arial, sans-serif" font-size="8" fill="white">SLLI/SRLI/SRAI 移位立即数</text>
  <text x="930" y="455" font-family="Arial, sans-serif" font-size="8" fill="white">SLTI/SLTIU 比较立即数</text>

  <!-- S型指令 -->
  <rect x="1100" y="390" width="160" height="75" fill="#9b59b6" stroke="#8e44ad" stroke-width="1" rx="4"/>
  <text x="1180" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">S型存储指令</text>
  <text x="1110" y="425" font-family="Arial, sans-serif" font-size="8" fill="white">SB 字节存储 rs2→M[rs1+imm]</text>
  <text x="1110" y="435" font-family="Arial, sans-serif" font-size="8" fill="white">SH 半字存储 (16位)</text>
  <text x="1110" y="445" font-family="Arial, sans-serif" font-size="8" fill="white">SW 字存储 (32位)</text>
  <text x="1110" y="455" font-family="Arial, sans-serif" font-size="8" fill="white">写掩码自动生成</text>

  <!-- I型加载指令 -->
  <rect x="1280" y="390" width="160" height="75" fill="#27ae60" stroke="#229954" stroke-width="1" rx="4"/>
  <text x="1360" y="410" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">I型加载指令</text>
  <text x="1290" y="425" font-family="Arial, sans-serif" font-size="8" fill="white">LB/LBU 字节加载</text>
  <text x="1290" y="435" font-family="Arial, sans-serif" font-size="8" fill="white">LH/LHU 半字加载</text>
  <text x="1290" y="445" font-family="Arial, sans-serif" font-size="8" fill="white">LW 字加载 M[rs1+imm]→rd</text>
  <text x="1290" y="455" font-family="Arial, sans-serif" font-size="8" fill="white">符号/零扩展控制</text>

  <!-- B型指令 -->
  <rect x="740" y="475" width="160" height="65" fill="#f39c12" stroke="#e67e22" stroke-width="1" rx="4"/>
  <text x="820" y="495" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">B型分支指令</text>
  <text x="750" y="510" font-family="Arial, sans-serif" font-size="8" fill="white">BEQ/BNE 相等/不等分支</text>
  <text x="750" y="520" font-family="Arial, sans-serif" font-size="8" fill="white">BLT/BGE 有符号比较分支</text>
  <text x="750" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">BLTU/BGEU 无符号比较分支</text>

  <!-- J型指令 -->
  <rect x="920" y="475" width="160" height="65" fill="#e67e22" stroke="#d35400" stroke-width="1" rx="4"/>
  <text x="1000" y="495" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">J型跳转指令</text>
  <text x="930" y="510" font-family="Arial, sans-serif" font-size="8" fill="white">JAL PC+imm→PC, PC+4→rd</text>
  <text x="930" y="520" font-family="Arial, sans-serif" font-size="8" fill="white">JALR rs1+imm→PC, PC+4→rd</text>
  <text x="930" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">JALR最低位清零</text>

  <!-- U型指令 -->
  <rect x="1100" y="475" width="160" height="65" fill="#8e44ad" stroke="#7d3c98" stroke-width="1" rx="4"/>
  <text x="1180" y="495" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">U型高位立即数</text>
  <text x="1110" y="510" font-family="Arial, sans-serif" font-size="8" fill="white">LUI imm[31:12]→rd[31:12]</text>
  <text x="1110" y="520" font-family="Arial, sans-serif" font-size="8" fill="white">AUIPC PC+imm→rd</text>
  <text x="1110" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">低12位自动清零</text>

  <!-- CSR系统指令 -->
  <rect x="1280" y="475" width="160" height="65" fill="#d35400" stroke="#ba4a00" stroke-width="1" rx="4"/>
  <text x="1360" y="495" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="white">CSR系统指令</text>
  <text x="1290" y="510" font-family="Arial, sans-serif" font-size="8" fill="white">ECALL/EBREAK/MRET</text>
  <text x="1290" y="520" font-family="Arial, sans-serif" font-size="8" fill="white">CSRRW/CSRRS CSR读写</text>
  <text x="1290" y="530" font-family="Arial, sans-serif" font-size="8" fill="white">异常处理和特权操作</text>

  <!-- ========== 信号分类说明 ========== -->
  
  <!-- 信号图例 -->
  <rect x="50" y="640" width="1390" height="120" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1" rx="5"/>
  <text x="745" y="665" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    核心信号分类与数据路径
  </text>

  <!-- 数据信号 -->
  <line x1="80" y1="690" x2="120" y2="690" stroke="#3498db" stroke-width="3" marker-end="url(#arrowhead-data)"/>
  <text x="130" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#3498db">数据信号</text>
  <text x="80" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 指令数据 (inst[31:0])</text>
  <text x="80" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 寄存器数据 (rs1/rs2_data[31:0])</text>
  <text x="80" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 内存数据 (mem_rdata[31:0])</text>

  <!-- 控制信号 -->
  <line x1="280" y1="690" x2="320" y2="690" stroke="#e74c3c" stroke-width="3" marker-end="url(#arrowhead-control)"/>
  <text x="330" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#e74c3c">控制信号</text>
  <text x="280" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• ALU操作码 (alu_op[3:0])</text>
  <text x="280" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 内存控制 (mem_we/mem_en)</text>
  <text x="280" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 寄存器写使能 (reg_wen)</text>

  <!-- 跳转信号 -->
  <line x1="480" y1="690" x2="520" y2="690" stroke="#f39c12" stroke-width="4" stroke-dasharray="8,4" marker-end="url(#arrowhead-jump)"/>
  <text x="530" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f39c12">跳转信号</text>
  <text x="480" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• PC更新 (next_pc[31:0])</text>
  <text x="480" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 分支控制 (branch/jump)</text>
  <text x="480" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• PC使能 (pc_update_en)</text>

  <!-- CSR信号 -->
  <line x1="680" y1="690" x2="720" y2="690" stroke="#9b59b6" stroke-width="3" stroke-dasharray="6,3" marker-end="url(#arrowhead-csr)"/>
  <text x="730" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#9b59b6">CSR异常信号</text>
  <text x="680" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• IDU→WBU: 控制信号 (csr_we/addr/op)</text>
  <text x="680" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• WBU→EXU: 读取数据 (mtvec/mepc/csr_rdata)</text>
  <text x="680" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• EXU→WBU: 写入数据 (csr_wdata)</text>

  <!-- ALU信号 -->
  <line x1="930" y1="690" x2="970" y2="690" stroke="#27ae60" stroke-width="3" marker-end="url(#arrowhead-alu)"/>
  <text x="980" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#27ae60">ALU信号</text>
  <text x="930" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 操作数选择 (alu_src1/2_sel)</text>
  <text x="930" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 运算结果 (alu_result[31:0])</text>
  <text x="930" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 标志位 (zero/carry/overflow)</text>

  <!-- 内存信号 -->
  <line x1="1180" y1="690" x2="1220" y2="690" stroke="#8b4513" stroke-width="3" marker-end="url(#arrowhead-mem)"/>
  <text x="1230" y="695" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#8b4513">内存信号</text>
  <text x="1180" y="710" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 访问宽度 (mem_width[1:0])</text>
  <text x="1180" y="725" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 写掩码 (mem_wmask[2:0])</text>
  <text x="1180" y="740" font-family="Arial, sans-serif" font-size="10" fill="#2c3e50">• 符号扩展 (mem_unsigned)</text>

  <!-- ========== 指令处理流程详细说明 ========== -->
  
  <rect x="50" y="780" width="1390" height="180" fill="#34495e" stroke="#2c3e50" stroke-width="2" rx="8"/>
  <text x="745" y="805" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
    详细指令处理流程 (单周期执行时序)
  </text>

  <!-- 算术指令流程 -->
  <text x="80" y="830" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f1c40f">算术指令 (ADD/SUB/AND/OR/XOR/SLL/SRL/SRA/SLT...):</text>
  <text x="80" y="845" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 从PC地址取指令 → ② IDU: 解码提取rs1/rs2/rd/funct3/funct7 → ③ EXU: 双操作数ALU运算</text>
  <text x="80" y="860" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">④ WBU: 运算结果写回rd寄存器 → ⑤ IFU: PC+4更新到下一指令</text>

  <!-- 跳转指令流程 -->
  <text x="80" y="885" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#e74c3c">跳转指令 (JAL/JALR/BEQ/BNE/BLT/BGE...):</text>
  <text x="80" y="900" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 取指令 → ② IDU: 解码分支/跳转类型 → ③ EXU: PC_ALU计算目标地址，主ALU做条件判断，独立分支逻辑</text>
  <text x="80" y="915" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">④ EXU: 产生pc_update_en信号 → ⑤ IFU: PC更新为目标地址 → ⑥ WBU: JAL/JALR将PC+4写回rd</text>

  <!-- 访存指令流程 -->
  <text x="80" y="940" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#9b59b6">访存指令 (LB/LH/LW/SB/SH/SW):</text>
  <text x="80" y="955" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 取指令 → ② IDU: 解码访存宽度/符号扩展 → ③ EXU: ALU计算内存地址(rs1+imm)</text>

  <!-- 异常指令流程 - 右侧 -->
  <text x="750" y="830" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#d35400">异常指令 (ECALL/MRET/EBREAK):</text>
  <text x="750" y="845" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 取指令 → ② IDU: 识别系统指令类型 → ③ WBU: 更新CSR寄存器状态</text>
  <text x="750" y="860" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">④ EXU: 获取异常向量/返回地址 → ⑤ IFU: PC跳转到异常处理程序/返回地址</text>

  <!-- CSR指令流程 -->
  <text x="750" y="885" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#8e44ad">CSR指令 (CSRRW/CSRRS):</text>
  <text x="750" y="900" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 取指令 → ② IDU: 解码CSR地址和操作类型 → ③ WBU: 读取CSR旧值</text>
  <text x="750" y="915" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">④ WBU: 根据操作类型更新CSR → ⑤ WBU: CSR旧值写回rd寄存器</text>

  <!-- 立即数指令流程 -->
  <text x="750" y="940" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#16a085">立即数指令 (LUI/AUIPC):</text>
  <text x="750" y="955" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">① IFU: 取指令 → ② IDU: 提取U型立即数 → ③ EXU: LUI直接传递/AUIPC与PC相加 → ④ WBU: 结果写回rd</text>

  <!-- ========== 架构特点和优化 ========== -->
  
  <rect x="50" y="980" width="1390" height="120" fill="#2c3e50" stroke="#1b2631" stroke-width="2" rx="8"/>
  <text x="745" y="1005" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="white">
    ysyx_24090003 CPU 架构特点与设计优化
  </text>

  <text x="80" y="1030" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#f39c12">• 单周期设计:</text>
  <text x="200" y="1030" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">每条指令在一个时钟周期内完成，简化控制逻辑</text>

  <text x="80" y="1050" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#3498db">• 双ALU架构:</text>
  <text x="200" y="1050" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">主ALU执行指令运算，PC_ALU专门处理地址计算，提高并行度</text>

  <text x="80" y="1070" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#e74c3c">• 完整异常处理:</text>
  <text x="200" y="1070" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">支持ECALL/MRET/EBREAK，四个CSR寄存器完整异常上下文</text>

  <text x="500" y="1030" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#9b59b6">• 跳转优先级控制:</text>
  <text x="650" y="1030" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">异常处理→无条件跳转→条件分支→顺序执行</text>

  <text x="500" y="1050" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#1abc9c">• 基本门电路实现:</text>
  <text x="650" y="1050" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">32位加法器、桶形移位器等均使用NAND门等基础逻辑</text>

  <text x="500" y="1070" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#27ae60">• 完整访存支持:</text>
  <text x="650" y="1070" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">字节/半字/字访问，符号/零扩展，写掩码自动生成</text>

  <text x="950" y="1030" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#d35400">• DPI-C仿真接口:</text>
  <text x="1100" y="1030" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">PC/执行/寄存器状态实时跟踪和调试</text>

  <text x="950" y="1050" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#c0392b">• 指令完整性:</text>
  <text x="1100" y="1050" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">支持RV32I基础指令集，包含所有算术/逻辑/访存/跳转/系统指令</text>

  <text x="950" y="1070" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#7f8c8d">• EXU独立分支判断:</text>
  <text x="1100" y="1070" font-family="Arial, sans-serif" font-size="10" fill="#ecf0f1">分支逻辑独立于ALU，基于ALU结果进行条件判断</text>

  <!-- 底部版权信息 -->
  <text x="720" y="1125" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#7f8c8d">
    ysyx_24090003 RISC-V CPU - 支持RV32I指令集，包含跳转控制、CSR异常处理和完整算术逻辑运算
  </text>

  <!-- ========== ysyx_24090003_computer 最外层框架 (最后绘制，在最上层) ========== -->
  <rect x="20" y="10" width="1450" height="1100" fill="none" stroke="#e74c3c" stroke-width="4" rx="12"/>
  <text x="250" y="35" font-family="Arial, sans-serif" font-size="18" font-weight="bold" text-anchor="middle" fill="#e74c3c">
    ysyx_24090003_computer
  </text>
  
  <!-- Computer内部内存访问DPI-C标记 -->
  <rect x="30" y="40" width="80" height="16" fill="#7f8c8d" stroke="#95a5a6" stroke-width="1" rx="2"/>
  <text x="70" y="50" font-family="Arial, sans-serif" font-size="8" font-weight="bold" text-anchor="middle" fill="white">DPI-C 内存访问跟踪</text>

  <!-- Computer框架内的版权信息 -->
  <text x="745" y="1090" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#7f8c8d">
    ysyx_24090003_computer - 完整计算机系统，包含CPU核心和内存访问接口，实现完整的RISC-V处理器
  </text>

</svg>
